# 渲染管线

<!-- TOC -->

- [渲染管线](#%E6%B8%B2%E6%9F%93%E7%AE%A1%E7%BA%BF)
    - [应用阶段](#%E5%BA%94%E7%94%A8%E9%98%B6%E6%AE%B5)
        - [准备场景数据](#%E5%87%86%E5%A4%87%E5%9C%BA%E6%99%AF%E6%95%B0%E6%8D%AE)
        - [加速/剔除](#%E5%8A%A0%E9%80%9F%E5%89%94%E9%99%A4)
        - [设置渲染状态](#%E8%AE%BE%E7%BD%AE%E6%B8%B2%E6%9F%93%E7%8A%B6%E6%80%81)
        - [调用GPU](#%E8%B0%83%E7%94%A8gpu)
    - [几何阶段](#%E5%87%A0%E4%BD%95%E9%98%B6%E6%AE%B5)
        - [顶点着色器](#%E9%A1%B6%E7%82%B9%E7%9D%80%E8%89%B2%E5%99%A8)
        - [顶点处理 可选](#%E9%A1%B6%E7%82%B9%E5%A4%84%E7%90%86-%E5%8F%AF%E9%80%89)
        - [投影](#%E6%8A%95%E5%BD%B1)
        - [裁剪](#%E8%A3%81%E5%89%AA)
        - [屏幕映射](#%E5%B1%8F%E5%B9%95%E6%98%A0%E5%B0%84)
    - [光栅化阶段](#%E5%85%89%E6%A0%85%E5%8C%96%E9%98%B6%E6%AE%B5)
    - [逐片元操作阶段](#%E9%80%90%E7%89%87%E5%85%83%E6%93%8D%E4%BD%9C%E9%98%B6%E6%AE%B5)
    - [后处理阶段](#%E5%90%8E%E5%A4%84%E7%90%86%E9%98%B6%E6%AE%B5)

<!-- /TOC -->

## 应用阶段
### 准备场景数据
- 物体数据
变换数据：位置、旋转、缩放
网格数据：顶点位置、UV

- 摄像机数据
位置、方向、远近裁剪平面
投影方式：正交|透视(FOV)
视口比例、尺寸

- 光源
	- 设置光源
 方向光：颜色、方向
 点光：位置、颜色、范围
 聚光：位置、颜色、方向\圆锥角
 
	- 设置阴影
是否需要阴影：判断是否有可投射阴影的物体
设置阴影参数：对应光源序号、阴影强度、级联参数、深度偏移、近平面偏移
逐光源绘制阴影贴图

### 加速/剔除
- 可见光裁剪
距离过远
视锥体与光锥体不相交

- 可见场景裁剪
视锥体
BVH等

### 设置渲染状态
- 渲染设置
使用的着色器
合批方式

- 渲染顺序
相对摄像机的距离
renderqueue等

- 输出的目标 (一或多) 
贴图
缓冲区

- 渲染方式
前向
延时

### 调用GPU
- 输出数据到显存
	- 顶点数据
位置
颜色
法线
uv坐标

	- 其他数据
mvp矩阵
纹理贴图

- 调用draw call

## 几何阶段
###  顶点着色器
- 坐标变换
- 逐顶点光照
计算颜色

###  顶点处理 (可选)
- 曲面细分着色器
细分图元

- 几何着色器
逐图元着色
生成更多图元

###  投影
- 正交
- 透视

###  裁剪
- 裁剪视野外的顶点
- 剔除三角图元的面片 (可编程)
自定义裁剪平面
自定义裁剪正面或背面
- 维度范围
	- D3D
x, y: [-1, 1]
z: [0, 1]
	- Opengl
x, y, z: [-1, 1]

###  屏幕映射
- 坐标原点
	- D3D
左上
	- Opengl
 左下

## 光栅化阶段
- 三角形设置
由顶点数据生成三角形

- 三角形遍历
根据像素被三角形网格覆盖的状况生成片元
	- 片元 = 像素+屏幕坐标+深度信息+法线+纹理坐标+...

## 逐片元操作阶段
- 片元着色器
纹理采样

- 片元合并
深度测试
模板测试
等
(可能在片元着色器之前)

- 颜色混合
片元颜色与缓冲区颜色混合 (可选)

- 输出至目标
颜色缓冲区
贴图

## 后处理阶段
- 后期处理
辉光
景深
fxaa
hdr